name: E2E Tests

on:
  deployment_status:

jobs:
  check-pr-status:
    name: Check if PR is open
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'
    outputs:
      pr-open: ${{ steps.pr-check.outputs.pr-open }}
      pr-number: ${{ steps.pr-check.outputs.pr-number }}
    steps:
      - name: Check PR status
        id: pr-check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.payload.deployment.sha
              });
              
              if (prs.length === 0) {
                console.log('No PR found for this deployment');
                core.setOutput('pr-open', 'false');
                core.setOutput('pr-number', '');
                return;
              }
              
              const pr = prs[0];
              const isOpen = pr.state === 'open';
              const isPromotionPR = pr.base && (pr.base.ref === 'qa' || pr.base.ref === 'prod' || pr.base.ref === 'main');
              
              console.log(`Found PR #${pr.number}, state: ${pr.state}, base: ${pr.base?.ref || 'unknown'}`);
              
              if (isPromotionPR) {
                console.log(`This is a promotion PR to ${pr.base.ref} - running tests regardless of PR state`);
                core.setOutput('pr-open', 'true');
                core.setOutput('pr-number', pr.number.toString());
              } else if (isOpen) {
                console.log(`PR is open - running tests`);
                core.setOutput('pr-open', 'true');
                core.setOutput('pr-number', pr.number.toString());
              } else {
                console.log(`Skipping tests - PR #${pr.number} is ${pr.state} and not a promotion PR`);
                core.setOutput('pr-open', 'false');
                core.setOutput('pr-number', pr.number.toString());
              }
            } catch (error) {
              console.error('Error checking PR status:', error);
              core.setOutput('pr-open', 'false');
              core.setOutput('pr-number', '');
            }

  stable-tests:
    name: Stable E2E Tests (Blocking)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-pr-status
    if: needs.check-pr-status.outputs.pr-open == 'true'
    permissions:
      actions: read
      contents: read
      pull-requests: write
      id-token: write
    env:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    steps:
      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::333022194791:role/web-app-e2e-tests
          aws-region: us-west-2

      - name: Debug deployment info
        run: |
          echo "Deployment environment: ${{ github.event.deployment_status.environment }}"
          echo "Deployment state: ${{ github.event.deployment_status.state }}"
          echo "Deployment URL: ${{ github.event.deployment_status.target_url }}"
          echo "Event name: ${{ github.event_name }}"

      - name: Set deployment URL
        id: deployment
        run: |
          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
          echo "Using deployment URL: $DEPLOYMENT_URL"
          echo "BASE_URL=$DEPLOYMENT_URL" >> "$GITHUB_ENV"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: e2e-tests
        run: npx playwright install --with-deps chromium

      - name: Run Stable Playwright Tests
        id: run-stable-tests
        working-directory: e2e-tests
        run: npx playwright test --project=stable
        env:
          BASE_URL: ${{ env.BASE_URL }}
          TEST_RUN_NAME: "Stable E2E Tests - PR Preview"
          TEST_USER_ADMIN: ${{ secrets.TEST_USER_ADMIN }}
          TEST_USER_ADMIN_PASSWORD: ${{ secrets.TEST_USER_ADMIN_PASSWORD }}

      - name: Upload stable test reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: stable-playwright-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            e2e-tests/playwright-report
            e2e-tests/test-results
          retention-days: 30

      - name: Parse stable test results
        if: always()
        id: stable-test-results
        shell: bash
        working-directory: e2e-tests
        run: |
          if [ -f "test-results/results.json" ]; then
            echo "Found results.json, parsing stable test results..."
            
            TOTAL_TESTS=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[]] | length' 2>/dev/null || echo "0")
            FAILED_COUNT=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == false)] | length' 2>/dev/null || echo "0")
            PASSED_COUNT=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == true)] | length' 2>/dev/null || echo "0")
            
            echo "Parsed: Total=$TOTAL_TESTS, Failed=$FAILED_COUNT, Passed=$PASSED_COUNT"
            
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            echo "passed_count=$PASSED_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              FAILED_TESTS=$(cat test-results/results.json | jq -r '[.. | .specs? // empty | .[] | select(.ok == false) | .title] | .[:10] | .[]' 2>/dev/null | sed 's/^/‚Ä¢ /' || echo "‚Ä¢ Failed to parse test names")
              if [ -z "$FAILED_TESTS" ]; then
                FAILED_TESTS="‚Ä¢ $FAILED_COUNT test(s) failed but names could not be parsed"
              fi
              echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
              echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "failed_tests=" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è  results.json file not found - stable tests may not have run"
            echo "failed_tests=‚Ä¢ Stable test results file not found (tests may not have started)" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "passed_count=0" >> $GITHUB_OUTPUT
            echo "total_tests=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with stable test results
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { failed_count, passed_count, total_tests, failed_tests } = ${{ toJSON(steps.stable-test-results.outputs) }};
            const testStatus = failed_count > 0 ? '‚ùå' : '‚úÖ';
            const deploymentUrl = '${{ env.BASE_URL }}';

            // Find PR associated with this deployment
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.deployment.sha
            });

            if (prs.length === 0) {
              console.log('No PR found for this deployment, skipping comment');
              return;
            }

            const prNumber = prs[0].number;
            console.log(`Found PR #${prNumber} for deployment`);

            let body = `## ${testStatus} Stable E2E Test Results (Blocking)\n\n`;
            body += `**Preview Deployment:** ${deploymentUrl}\n\n`;
            body += `**Stable Test Results:**\n`;
            body += `- ‚úÖ Passed: ${passed_count}\n`;
            body += `- ‚ùå Failed: ${failed_count}\n`;
            body += `- üìä Total: ${total_tests}\n\n`;

            if (failed_count > 0 && failed_tests) {
              body += `**Failed Stable Tests:**\n${failed_tests}\n\n`;
            }

            body += `[View full test report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Notify Slack on Stable Test Success
        if: steps.run-stable-tests.outcome == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '‚úÖ Stable E2E Tests Passed',
              attachments: [{
                color: 'good',
                text: `${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nURL: ${{ env.BASE_URL }}\n‚úÖ ${{ steps.stable-test-results.outputs.passed_count }}/${{ steps.stable-test-results.outputs.total_tests }} stable tests passed\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Stable Test Failure
        if: steps.run-stable-tests.outcome == 'failure' || failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "‚ö†Ô∏è Stable E2E Tests Failed",
              "attachments": [{
                "color": "warning",
                "text": "${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nURL: ${{ env.BASE_URL }}\n\n‚ùå ${{ steps.stable-test-results.outputs.failed_count }} failed\n‚úÖ ${{ steps.stable-test-results.outputs.passed_count }} passed\nüìä ${{ steps.stable-test-results.outputs.total_tests }} total\n\nFailed Tests:\n${{ steps.stable-test-results.outputs.failed_tests || '(Unable to parse test results)' }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  experimental-tests:
    name: Experimental E2E Tests (Non-blocking)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-pr-status
    if: needs.check-pr-status.outputs.pr-open == 'true'
    permissions:
      actions: read
      contents: read
      pull-requests: write
      id-token: write
    env:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    steps:
      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::333022194791:role/web-app-e2e-tests
          aws-region: us-west-2

      - name: Debug deployment info
        run: |
          echo "Deployment environment: ${{ github.event.deployment_status.environment }}"
          echo "Deployment state: ${{ github.event.deployment_status.state }}"
          echo "Deployment URL: ${{ github.event.deployment_status.target_url }}"
          echo "Event name: ${{ github.event_name }}"

      - name: Set deployment URL
        id: deployment
        run: |
          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
          echo "Using deployment URL: $DEPLOYMENT_URL"
          echo "BASE_URL=$DEPLOYMENT_URL" >> "$GITHUB_ENV"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: e2e-tests
        run: npx playwright install --with-deps chromium

      - name: Run Experimental Playwright Tests
        id: run-experimental-tests
        working-directory: e2e-tests
        run: npx playwright test --project=experimental
        continue-on-error: true # Don't fail the workflow if experimental tests fail
        env:
          BASE_URL: ${{ env.BASE_URL }}
          TEST_RUN_NAME: "Experimental E2E Tests - PR Preview"
          TEST_USER_ADMIN: ${{ secrets.TEST_USER_ADMIN }}
          TEST_USER_ADMIN_PASSWORD: ${{ secrets.TEST_USER_ADMIN_PASSWORD }}

      - name: Upload experimental test reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: experimental-playwright-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            e2e-tests/playwright-report
            e2e-tests/test-results
          retention-days: 30

      - name: Parse experimental test results
        if: always()
        id: experimental-test-results
        shell: bash
        working-directory: e2e-tests
        run: |
          if [ -f "test-results/results.json" ]; then
            echo "Found results.json, parsing experimental test results..."
            
            TOTAL_TESTS=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[]] | length' 2>/dev/null || echo "0")
            FAILED_COUNT=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == false)] | length' 2>/dev/null || echo "0")
            PASSED_COUNT=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == true)] | length' 2>/dev/null || echo "0")
            
            echo "Parsed: Total=$TOTAL_TESTS, Failed=$FAILED_COUNT, Passed=$PASSED_COUNT"
            
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            echo "passed_count=$PASSED_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              FAILED_TESTS=$(cat test-results/results.json | jq -r '[.. | .specs? // empty | .[] | select(.ok == false) | .title] | .[:10] | .[]' 2>/dev/null | sed 's/^/‚Ä¢ /' || echo "‚Ä¢ Failed to parse test names")
              if [ -z "$FAILED_TESTS" ]; then
                FAILED_TESTS="‚Ä¢ $FAILED_COUNT test(s) failed but names could not be parsed"
              fi
              echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
              echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "failed_tests=" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è  results.json file not found - experimental tests may not have run"
            echo "failed_tests=‚Ä¢ Experimental test results file not found (tests may not have started)" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "passed_count=0" >> $GITHUB_OUTPUT
            echo "total_tests=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with experimental test results
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { failed_count, passed_count, total_tests, failed_tests } = ${{ toJSON(steps.experimental-test-results.outputs) }};
            const testStatus = failed_count > 0 ? '‚ö†Ô∏è' : '‚úÖ';
            const deploymentUrl = '${{ env.BASE_URL }}';

            // Find PR associated with this deployment
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.deployment.sha
            });

            if (prs.length === 0) {
              console.log('No PR found for this deployment, skipping comment');
              return;
            }

            const prNumber = prs[0].number;
            console.log(`Found PR #${prNumber} for deployment`);

            let body = `## ${testStatus} Experimental E2E Test Results (Non-blocking)\n\n`;
            body += `**Preview Deployment:** ${deploymentUrl}\n\n`;
            body += `**Experimental Test Results:**\n`;
            body += `- ‚úÖ Passed: ${passed_count}\n`;
            body += `- ‚ö†Ô∏è Failed: ${failed_count}\n`;
            body += `- üìä Total: ${total_tests}\n\n`;

            if (total_tests === 0) {
              body += `*No experimental tests found - all tests are currently stable.*\n\n`;
            } else if (failed_count > 0 && failed_tests) {
              body += `**Failed Experimental Tests (non-blocking):**\n${failed_tests}\n\n`;
            }

            body += `[View full test report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Notify Slack on Experimental Test Failure
        if: steps.run-experimental-tests.outcome == 'failure' || failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "‚ö†Ô∏è Experimental E2E Tests Failed",
              "attachments": [{
                "color": "warning",
                "text": "${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nURL: ${{ env.BASE_URL }}\n\n‚ùå ${{ steps.experimental-test-results.outputs.failed_count }} failed\n‚úÖ ${{ steps.experimental-test-results.outputs.passed_count }} passed\nüìä ${{ steps.experimental-test-results.outputs.total_tests }} total\n\nFailed Tests:\n${{ steps.experimental-test-results.outputs.failed_tests || '(Unable to parse test results)' }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  visual-tests:
    name: Visual Diff Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-pr-status
    if: needs.check-pr-status.outputs.pr-open == 'true'
    continue-on-error: true
    permissions:
      actions: read
      contents: read
      pull-requests: write
      id-token: write
    env:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    steps:
      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::333022194791:role/web-app-e2e-tests
          aws-region: us-west-2

      - name: Set deployment URL
        run: |
          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
          echo "Using deployment URL: $DEPLOYMENT_URL"
          echo "BASE_URL=$DEPLOYMENT_URL" >> "$GITHUB_ENV"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: e2e-tests
        run: npx playwright install --with-deps chromium

      - name: Run Visual Diff Tests
        id: run-visual-tests
        working-directory: e2e-tests
        run: |
          if [ "${{ env.UPDATE_VISUAL_BASELINES }}" == "true" ]; then
            echo "üì∏ Updating visual baselines..."
            npx playwright test --project=visual --update-snapshots
          else
            echo "üîç Comparing against committed baselines..."
            npx playwright test --project=visual
          fi
        env:
          BASE_URL: ${{ env.BASE_URL }}
          VISUAL_TESTS: "true"
          UPDATE_VISUAL_BASELINES: "true"
          TEST_USER_ADMIN: ${{ secrets.TEST_USER_ADMIN }}
          TEST_USER_ADMIN_PASSWORD: ${{ secrets.TEST_USER_ADMIN_PASSWORD }}

      - name: Upload visual baselines
        if: env.UPDATE_VISUAL_BASELINES == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: visual-baselines-${{ github.run_id }}-${{ github.run_attempt }}
          path: e2e-tests/tests/**/__visual_snapshots__/**
          retention-days: 30

      - name: Upload visual diff report
        if: env.UPDATE_VISUAL_BASELINES != 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: e2e-tests/playwright-report
          retention-days: 30

      - name: Comment PR with visual test results
        if: always() && needs.check-pr-status.outputs.pr-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const outcome = '${{ steps.run-visual-tests.outcome }}';
            const isBaselining = '${{ env.UPDATE_VISUAL_BASELINES }}' === 'true';
            const prNumber = parseInt('${{ needs.check-pr-status.outputs.pr-number }}', 10);

            let body;
            if (isBaselining) {
              body = `## üì∏ Visual Baselines Generated\n\n`;
              body += `Visual baselines have been captured. Download the **visual-baselines** artifact from the Actions run and commit them:\n\n`;
              body += "```bash\n";
              body += "# Download and extract the artifact, then:\n";
              body += "git add e2e-tests/tests/__visual_snapshots__/\n";
              body += 'git commit -m "chore: add visual baselines"\n';
              body += "```\n\n";
            } else {
              const icon = outcome === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
              body = `## ${icon} Visual Diff Tests\n\n`;

              if (outcome === 'success') {
                body += `No visual regressions detected ‚Äî UI matches the committed baselines.\n\n`;
              } else {
                body += `Visual differences were detected. Download the **visual-diff-report** artifact from the Actions run to review the screenshot diffs.\n\n`;
                body += `If this is an **intentional** UI change, update the baselines and commit them:\n`;
                body += "```bash\n";
                body += `BASE_URL=${{ env.BASE_URL }} npm run test:visual:update\n`;
                body += `git add e2e-tests/tests/__visual_snapshots__/\n`;
                body += `git commit -m "chore: update visual baselines"\n`;
                body += "```\n\n";
              }
            }

            body += `[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body,
            });

