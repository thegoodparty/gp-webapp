name: E2E Tests

on:
  pull_request:
    branches: ['develop', 'qa', 'master']
  
  deployment_status:
    environments:
      - 'Preview - gp-ui'
      - 'Production - gp-ui'
      
  schedule:
    # Run at midnight PST (8 AM UTC)
    - cron: '0 8 * * *'
    
jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run on PR, successful deployments, or scheduled runs
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule' ||
      github.event.deployment_status.state == 'success'
    # Only fail workflow for PR tests (blocking), not for monitoring
    continue-on-error: ${{ github.event_name != 'pull_request' }}
    permissions:
      actions: read
      contents: read
      pull-requests: write
    steps:
      - name: Determine test context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "type=scheduled" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "type=post-deploy" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.deployment_status.environment }}" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Vercel Preview (PR only)
        if: github.event_name == 'pull_request'
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.1
        id: vercel-preview
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 10

      - name: Set deployment URL
        id: deployment
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BASE_URL=${{ steps.vercel-preview.outputs.url }}" >> "$GITHUB_ENV"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "BASE_URL=https://goodparty.org" >> "$GITHUB_ENV"
          else
            echo "BASE_URL=${{ github.event.deployment_status.target_url }}" >> "$GITHUB_ENV"
          fi
          echo "Deployment URL: ${{ env.BASE_URL }}"

      - name: Checkout test-automation Repository
        uses: actions/checkout@v4
        with:
          repository: thegoodparty/test-automation
          token: ${{ secrets.GH_PAT_TEST }}
          path: test-automation
          ref: develop

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: test-automation/package-lock.json

      - name: Install Dependencies
        working-directory: test-automation
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: test-automation
        run: npx playwright install --with-deps

      - name: Run Playwright Tests
        id: run-tests
        working-directory: test-automation
        run: npx playwright test
        env:
          BASE_URL: ${{ env.BASE_URL }}
          TEST_RUN_NAME: "E2E Tests - ${{ steps.context.outputs.environment }} - ${{ github.event_name }}"
          TEST_USER_ADMIN: ${{ secrets.TEST_USER_ADMIN }}
          TEST_USER_ADMIN_PASSWORD: ${{ secrets.TEST_USER_ADMIN_PASSWORD }}

      - name: Upload test reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            test-automation/playwright-report
            test-automation/test-results
          retention-days: 30

      - name: Parse test results
        if: always()
        id: test-results
        shell: bash
        working-directory: test-automation
        run: |
          if [ -f "test-results/results.json" ]; then
            echo "Found results.json, parsing test results..."
            
            TOTAL_TESTS=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[]] | length' 2>/dev/null || echo "0")
            FAILED_COUNT=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == false)] | length' 2>/dev/null || echo "0")
            PASSED_COUNT=$(cat test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == true)] | length' 2>/dev/null || echo "0")
            
            echo "Parsed: Total=$TOTAL_TESTS, Failed=$FAILED_COUNT, Passed=$PASSED_COUNT"
            
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            echo "passed_count=$PASSED_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              FAILED_TESTS=$(cat test-results/results.json | jq -r '[.. | .specs? // empty | .[] | select(.ok == false) | .title] | .[:10] | .[]' 2>/dev/null | sed 's/^/‚Ä¢ /' || echo "‚Ä¢ Failed to parse test names")
              if [ -z "$FAILED_TESTS" ]; then
                FAILED_TESTS="‚Ä¢ $FAILED_COUNT test(s) failed but names could not be parsed"
              fi
              echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
              echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "tests_ran=true" >> $GITHUB_OUTPUT
            else
              echo "failed_tests=" >> $GITHUB_OUTPUT
              if [ "$TOTAL_TESTS" -gt 0 ]; then
                echo "tests_ran=true" >> $GITHUB_OUTPUT
              else
                echo "tests_ran=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "‚ö†Ô∏è  results.json file not found - tests may not have run"
            echo "failed_tests=‚Ä¢ Test results file not found (tests may not have started)" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "passed_count=0" >> $GITHUB_OUTPUT
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "tests_ran=false" >> $GITHUB_OUTPUT
          fi

      # PR Comment - Only on pull requests
      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { failed_count, passed_count, total_tests, failed_tests } = ${{ toJSON(steps.test-results.outputs) }};
            const testStatus = failed_count > 0 ? '‚ùå' : '‚úÖ';
            const deploymentUrl = '${{ env.BASE_URL }}';
            
            let body = `## ${testStatus} E2E Test Results\n\n`;
            body += `**Preview Deployment:** ${deploymentUrl}\n\n`;
            body += `**Results:**\n`;
            body += `- ‚úÖ Passed: ${passed_count}\n`;
            body += `- ‚ùå Failed: ${failed_count}\n`;
            body += `- üìä Total: ${total_tests}\n\n`;
            
            if (failed_count > 0 && failed_tests) {
              body += `**Failed Tests:**\n${failed_tests}\n\n`;
            }
            
            body += `[View full test report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # Slack Notifications - Only for non-PR events (post-deploy & scheduled)
      - name: Notify Slack on Test Success
        if: github.event_name != 'pull_request' && steps.run-tests.outcome == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '‚úÖ E2E Tests Passed',
              attachments: [{
                color: 'good',
                text: `${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ steps.context.outputs.environment }}\nURL: ${{ env.BASE_URL }}\n‚úÖ ${{ steps.test-results.outputs.passed_count }}/${{ steps.test-results.outputs.total_tests }} tests passed\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Test Failure
        if: github.event_name != 'pull_request' && (steps.run-tests.outcome == 'failure' || failure())
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "‚ö†Ô∏è E2E Tests Failed",
              "attachments": [{
                "color": "warning",
                "text": "${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ steps.context.outputs.environment }}\nURL: ${{ env.BASE_URL }}\n\n‚ùå ${{ steps.test-results.outputs.failed_count }} failed\n‚úÖ ${{ steps.test-results.outputs.passed_count }} passed\nüìä ${{ steps.test-results.outputs.total_tests }} total\n\nFailed Tests:\n${{ steps.test-results.outputs.failed_tests || '(Unable to parse test results)' }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
