name: Visual Tests (On Demand)

# Two trigger methods:
# 1. Comment "/visual-test" on a PR (works once this file is on the default branch)
# 2. Manually via Actions UI ‚Üí "Run workflow" ‚Üí pick your branch (works from any branch)
# Both find the latest Vercel deployment for the branch ‚Äî no new commit needed.

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

jobs:
  visual-tests:
    name: Visual Diff Tests (On Demand)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.pull_request != null && github.event.comment.body == '/visual-test')
    continue-on-error: true
    permissions:
      actions: read
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::333022194791:role/web-app-e2e-tests
          aws-region: us-west-2

      - name: Find latest Vercel deployment URL
        id: find-deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let headSha, branchRef, prNumber;

            if (context.eventName === 'issue_comment') {
              prNumber = context.payload.issue.number;

              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              headSha = pr.head.sha;
              branchRef = pr.head.ref;

              // React to the comment so the user knows it was received
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes',
              });
            } else {
              // workflow_dispatch ‚Äî use the branch selected in the UI
              branchRef = context.ref.replace('refs/heads/', '');
              headSha = context.sha;
            }

            core.setOutput('head-sha', headSha);
            core.setOutput('pr-number', prNumber || '');
            core.setOutput('event-name', context.eventName);

            // Look for a successful Vercel deployment on the head SHA first,
            // then fall back to the most recent successful deployment on the branch.
            const searchRefs = [headSha, `refs/heads/${branchRef}`];

            for (const ref of searchRefs) {
              const { data: deployments } = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: ref,
                per_page: 10,
              });

              for (const deployment of deployments) {
                const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                });
                const success = statuses.find(s => s.state === 'success' && s.target_url);
                if (success) {
                  console.log(`Found deployment URL: ${success.target_url} (ref: ${ref})`);
                  core.setOutput('deployment-url', success.target_url);
                  core.setOutput('found', 'true');
                  return;
                }
              }
            }

            // No deployment found
            core.setOutput('found', 'false');
            const msg = `## ‚ö†Ô∏è Visual Diff Tests ‚Äî No Deployment Found\n\nNo successful Vercel deployment was found for branch \`${branchRef}\`. Push a commit to trigger a Vercel preview deployment, then try again.`;

            if (prNumber) {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: msg,
              });
            } else {
              core.warning(msg);
            }

      - name: Stop if no deployment found
        if: steps.find-deployment.outputs.found != 'true'
        run: |
          echo "No deployment found, aborting."
          exit 1

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.find-deployment.outputs.head-sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: e2e-tests
        run: npx playwright install --with-deps chromium

      - name: Run Visual Diff Tests
        id: run-visual-tests
        working-directory: e2e-tests
        run: |
          echo "üîç Comparing against committed baselines"
          npx playwright test --project=visual
        env:
          BASE_URL: ${{ steps.find-deployment.outputs.deployment-url }}
          VISUAL_TESTS: "true"
          TEST_USER_ADMIN: ${{ secrets.TEST_USER_ADMIN }}
          TEST_USER_ADMIN_PASSWORD: ${{ secrets.TEST_USER_ADMIN_PASSWORD }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Upload visual diff report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: e2e-tests/playwright-report
          retention-days: 30

      - name: Comment PR with results
        if: steps.find-deployment.outputs.found == 'true' && steps.find-deployment.outputs.pr-number != '' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const outcome = '${{ steps.run-visual-tests.outcome }}';
            const icon = outcome === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            const deploymentUrl = '${{ steps.find-deployment.outputs.deployment-url }}';
            const prNumber = parseInt('${{ steps.find-deployment.outputs.pr-number }}', 10);

            let body = `## ${icon} Visual Diff Tests (On Demand)\n\n`;
            body += `**Preview Deployment:** ${deploymentUrl}\n\n`;

            if (outcome === 'success') {
              body += `No visual regressions detected ‚Äî UI matches the committed baselines.\n\n`;
            } else {
              body += `Visual differences were detected. Download the **visual-diff-report** artifact from the Actions run to review the screenshot diffs.\n\n`;
              body += `If this is an **intentional** UI change, update the baselines and commit them:\n`;
              body += "```bash\n";
              body += `BASE_URL=${deploymentUrl} npm run test:visual:update\n`;
              body += `git add e2e-tests/tests/__visual_snapshots__/\n`;
              body += `git commit -m "chore: update visual baselines"\n`;
              body += "```\n\n";
            }

            body += `[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body,
            });
